<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">

	<!-- Configuracion vue and vuerify  -->
	<link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet">
	<link href="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.min.css" rel="stylesheet">
	<!-- Configuracion vue and vuerify  -->

	<title>{% block title %}{% endblock %}</title>
	{% load static %}

</head>
<body>
	<div id="app">
		<v-container v-if="showProgress" style="height: 100vh;" fill-height justify-center align-center>
			<v-layout justify-center align-center>
				<v-flex shrink>
					<v-progress-circular
						:size="130"
						:width="7"
						color="grey"
						indeterminate
					></v-progress-circular>
				</v-flex>
			</v-layout>
		</v-container>

		<v-app v-else id="inspire">
			<v-navigation-drawer fixed :clipped="$vuetify.breakpoint.mdAndUp" app v-model="drawer">
				<v-list dense>
					<template v-for="item in routes">
						<v-layout row v-if="item.heading" align-center :key="item.heading">
							<v-flex xs6>
								<v-subheader v-if="item.heading">
									${ item.heading }
								</v-subheader>
							</v-flex>

							<v-flex xs6 class="text-xs-center">
								<a href="#!" class="body-2 black--text">EDIT</a>
							</v-flex>
						</v-layout>

						<v-list-group v-else-if="item.children" v-model="item.model" :key="item.text"
							:prepend-icon="item.model ? item.icon : item['icon-alt']" append-icon="" >

							<v-list-tile slot="activator">
								<v-list-tile-content>
									<v-list-tile-title >
										${ item.text }
									</v-list-tile-title>
								</v-list-tile-content>
							</v-list-tile>

							<v-list-tile v-for="(child, i) in item.children" :key="i" @click="" :href="child.url">
								<v-list-tile-action >
									<v-icon>${ child.icon }</v-icon>
								</v-list-tile-action>

								<v-list-tile-content>
									<v-list-tile-title>
										${ child.text }
									</v-list-tile-title>
								</v-list-tile-content>
							</v-list-tile>

						</v-list-group>

						<v-list-tile v-else @click="" :key="item.text" :href="item.url">
							<v-list-tile-action>
								<v-icon>${ item.icon }</v-icon>
							</v-list-tile-action>

							<v-list-tile-content>
								<v-list-tile-title>
									${ item.text }
								</v-list-tile-title>
							</v-list-tile-content>

						</v-list-tile>
					</template>
				</v-list>
			</v-navigation-drawer>

			<v-toolbar color="blue darken-3" dark app :clipped-left="$vuetify.breakpoint.mdAndUp"	fixed>
				<v-toolbar-title style="width: 300px" class="ml-0 pl-3">
					<v-toolbar-side-icon @click.stop="drawer = !drawer"></v-toolbar-side-icon>
					<span class="hidden-sm-and-down">SGD - ETITC</span>
				</v-toolbar-title>

				<v-text-field 
					flat
					solo-inverted
					prepend-icon="search"
					label="Buscar"
					class="hidden-sm-and-down"
				></v-text-field>

				<v-spacer></v-spacer>

				<v-btn icon>
					<v-icon>apps</v-icon>
				</v-btn>

				<v-btn icon>
					<v-icon>notifications</v-icon>
				</v-btn>

				<v-btn icon large>
					<v-avatar size="32px" tile>
						<img
							src="https://github.com/vuetifyjs.png?size=100"
							alt="Vuetify"
						>
					</v-avatar>
				</v-btn>
			</v-toolbar>

			<v-content>
				<v-container fluid>
					<v-layout>
						{% block content %}
						
						{% endblock content %}
					</v-layout>
				</v-container>
			</v-content>
			<v-btn
				fab
				bottom
				right
				color="pink"
				dark
				fixed
				@click.stop="dialog = !dialog"
			>
				<v-icon>email</v-icon>
			</v-btn>
			<v-dialog v-model="dialog" width="800px">
				<v-card>
					<v-card-title
						class="grey lighten-4 py-4 title"
					>
						Contactar Administrador
					</v-card-title>
					<v-container grid-list-sm class="pa-4">
						<v-layout row wrap>
							<v-form style="width: 100%" ref="form" v-model="formValid" lazy-validation>
								{% csrf_token %}
								<v-flex xs12 align-center justify-space-between>
									<v-layout align-center>
										<v-text-field
											clearable
											prepend-icon="subject"
											label="Asunto"
											v-model="sendMail.subject"
											:rules="rules.subjectRules" 
										></v-text-field>
									</v-layout>
								</v-flex>
								<v-flex xs12>
									<v-text-field
										clearable
										prepend-icon="mail"
										label="Correo Electronico"
										v-model="sendMail.from_email"
										:rules="rules.emailRules"
									></v-text-field>
								</v-flex>
								<v-flex xs12>
									<v-textarea 
										clearable
										prepend-icon="message"
										label="Mensaje"
										v-model="sendMail.message"
										:rules="rules.msgRules"
									></v-textarea>
								</v-flex>
								<v-flex xs12>
									<template>
										<v-progress-linear :indeterminate="progress.indeterminate" :active="progress.active"></v-progress-linear>
									</template>
								</v-flex>
								<v-flex xs12>
									<template>
										<div style="width: 100%">
											<v-alert 
												:value="sendMail.value" 
												:type="sendMail.type" 
												transition="scale-transition" 
												dismissible>
													${ sendMail.msg }
											</v-alert>
										</div>
									</template>
								</v-flex>
							</v-form>
						</v-layout>
					</v-container>
					<v-card-actions>
						<v-spacer></v-spacer>
						<v-btn flat color="primary" @click="dialog = false; clear()">Cerrar</v-btn>
						<v-btn flat @click="send" :disabled="!formValid">Enviar</v-btn>
					</v-card-actions>
				</v-card>
			</v-dialog>
		</v-app>
	</div>

	<!-- Configuracion vue and vuerify  -->
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vuetify/dist/vuetify.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.1"></script>
	<script>

			var getCookie = function(cname){
				var name = cname + "=";
				var decodedCookie = decodeURIComponent(document.cookie);
				var ca = decodedCookie.split(';');
				for(var i = 0; i <ca.length; i++) {
						var c = ca[i];
						while (c.charAt(0) == ' ') {
								c = c.substring(1);
						}
						if (c.indexOf(name) == 0) {
								return c.substring(name.length, c.length);
						}
				}
				return "";
			} 

	Vue.options.delimiters = ['${', '}'];
	Vue.http.interceptors.push(function(request) {
		request.headers.set('X-CSRFToken', getCookie('csrftoken'));
	});

	var app = new Vue({
		el: '#app',
		computed: {
			staff(){
				return "{{ request.user.is_staff }}" == "True";
			}
		},
		data(){
      return {
				dialog: false,
				drawer: null,
				showProgress: true,
				routes: [],
				paginate_by: [],
				select_paginate_by: parseInt('{{ paginate_by }}'),
				sendMail: {
					subject: '',
					from_email: '',
					message:'',
					value: false,
					type: 'info'
				},
				progress: {
					active: false,
					indeterminate: false
				},
				rules: {
      		subjectRules: [
						v => !!v || 'Este campo es obligatorio'
					],
					emailRules: [
						v => !!v || 'Este campo es obligatorio',
						v => (v &&  /^[_a-z0-9-]+(.[_a-z0-9-]+)*@[a-z0-9-]+(.[a-z0-9-]+)*(.[a-z]{2,4})$/gi.test(v)) || 'El valor no es un correo electronico valido'
					],
					msgRules: [
						v => !!v || 'Este campo es obligatorio'
					]
				},
				formValid: true
			}
		},
		created() {
			this.drawer = true;
			
			this.$http.get("{% static 'core/json/routes.json' %}").then((res) => {
				this.routes = res.body.routes;
			})

			this.paginate_by = [50, 100, 200, 300]
		},
		methods: {
			send(){
				if (!this.$refs.form.validate())
					return;

				this.progress.active = true;
				this.progress.indeterminate = true;

				this.$http.get("{% url 'email'  %}", { params: this.sendMail}).then(res => {
					this.sendMail.msg = res.body.msg;
					this.sendMail.value = res.body.ok;
					this.sendMail.type = res.body.type;
					this.clear();
					this.closeAlert();
				}, res => {
					this.progress = {
						active: false,
						indeterminate: false
					}
					this.closeAlert();
					console.log(res);
				});
			},
			clear(){
				this.sendMail.subject = '';
				this.sendMail.from_email = '';
				this.sendMail.message = '';

				this.progress = {
					active: false,
					indeterminate: false
				}

				this.$refs.form.reset()
			},
			closeAlert(){
				setTimeout(() => {
					this.sendMail.value = false;
				}, 5000)
			}
		},
		mounted() {
			setTimeout(() => {
				this.showProgress = !this.showProgress;
			}, 500);
		},
		props: {
			source: String
		}
	});
		
	</script>
	
	<!-- Configuracion vue and vuerify  -->

	{% block extra_vuejs %}
	
	{% endblock extra_vuejs %}
</body>
</html>